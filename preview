#!/usr/bin/env php
<?php

$files = array(
    __DIR__ . '/vendor/autoload.php',
    __DIR__ . '/../../autoload.php'
);

foreach ($files as $f) {
    if (file_exists($f)) {
        require_once $f;
        define("PREVIEW_INSTALLED", true);
        break;
    }
}

if (!defined("PREVIEW_INSTALLED")) {
    die("Preview is not correctly installed");
}

use \Preview\Configuration;
use \Preview\Loader;
use \Preview\World;
use \Preview\Reporter\Spec as SpecReporter;

Configuration::set_reporter(new SpecReporter);

// Since for PHP version < 5.4 $this is not available for closure,
// We can't use this feature, instead we explicitly pass
// the context object as an argument to callback.
if (version_compare(phpversion(), '5.4', '<')) {
    Configuration::$use_implicit_context = false;
}

// \Preview\Configuration::set_assertion_error();
// \Preview\Configuration::$test_groups = array("pop");

$loader = new Loader;
foreach ($argv as $arg) {
    $loader->load($arg);
}

$results = World::run();

foreach($results as $result) {
    if ($result->error()) {
        exit(1);
    }
}
exit(0);
