#!/usr/bin/env php
<?php

$files = array(
    __DIR__ . '/vendor/autoload.php',
    __DIR__ . '/../../autoload.php'
);

foreach ($files as $f) {
    if (file_exists($f)) {
        require_once $f;
        define("PREVIEW_INSTALLED", true);
        break;
    }
}

if (!defined("PREVIEW_INSTALLED")) {
    die("Preview is not correctly installed");
}

use \Preview\Preview;
use \Preview\World;
use \Preview\Configuration;
use \Preview\Loader;
use \Preview\Reporter\Spec as SpecReporter;

use Ulrichsg\Getopt;

Preview::$world = new World;
Preview::$config = new Configuration;
$loader = new Loader;

Preview::$config->reporter = new SpecReporter;

// Since for PHP version < 5.4 $this is not available for closure,
// We can't use this feature, instead we explicitly pass
// the context object as an argument to callback.
if (Preview::php_version_is_53()) {
    Preview::$config->use_implicit_context = false;
}

// handle command line args
$cmd = new Getopt(
    array(
        array(
            "h", "help", Getopt::NO_ARGUMENT,
            "Show this help message."
        ),
        array(
            "r", "reporter", Getopt::REQUIRED_ARGUMENT,
            "Set reporter"
        ),
        array(
            null, "no-color", Getopt::REQUIRED_ARGUMENT,
            "Disable color output."
        ),
        array(
            "g", "group", Getopt::REQUIRED_ARGUMENT,
            "Test group(s). use comma(,) to seperate groups"
        ),
        array(
            null, "list-groups", Getopt::NO_ARGUMENT,
            'List all the test groups'
        ),
        array(
            "n", "no-this", Getopt::NO_ARGUMENT,
            'Disable using $this as an implicit context. '.
            'Only for php 5.4 and above.'
        ),
    )
);
$cmd->parse();
$options = $cmd->getOptions();

if (isset($options["help"])) {
    $cmd->showHelp();
    exit(0);
}

if (isset($options["no-color"])) {
    Preview::$config->color_support = false;
}

if (isset($options["reporter"])) {
    $reporter = "\\Preview\\Reporter\\{$options['reporter']}";
    Preview::$config->reporter = new $reporter;
}

if (isset($options["group"])) {
    Preview::$config->test_groups = explode(",", $options["group"]);
}

if (isset($options["no-this"])) {
    Preview::$config->use_implicit_context = false;
}

$files = $cmd->getOperands();

// default help message
if (empty($options) and empty($files)) {
    $cmd->showHelp();
    exit(0);
}

// load all test file
foreach ($files as $file) {
    $loader->load($file);
}

if (isset($options["list-groups"])) {
    $groups = array_keys(Preview::$world->groups());
    if (empty($groups)) {
        echo "    No test groups.";
        exit(0);
    }
    foreach ($groups as $index => $group) {
        $index = $index + 1;
        echo "    $index) $group".PHP_EOL;
    }
    exit(0);
}

// run test and exit.
$results = Preview::$world->run();
foreach($results as $result) {
    if ($result->error()) {
        exit(1);
    }
}

exit(0);